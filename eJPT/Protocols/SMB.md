SMB stands for Server Message Block. It is a protocol that allows file and resources (like printers) sharing in a network with Windows machines. An open source version also exists for Linux called Samba.
It usually runs on TCP ports **445** or **139**. Can also be on UDP **137** or **138** 

There are two levels of authentication on SMB, both using a challenge-response. The first one is **user level**, which identifies a user. The second one us **share level**, which only requires a password, and gives access to a single share.

## Normal Use :
+ On Windows :
	+ To add a network drive :
		+ Explorer
		+ Map Network Drive
		+ Folder : `\\\IP_addr\`
	+ Alternatively :
		+ `net use Z: \\IP_addr\folder$ passwd /user:username`
	+ To delete one :
		+ `net use * /delete`
+ On Linux :
	+ `smbclient -L IP -N` to list shares with a NULL session
	+ `smbclient //IP/Share/` to connect to a share
	+ `rpcclient -U "" -N IP` to open a NULL session and send commands
		+ An actual user can also be provided

## Nmap scripts to enumerate :
+ `smb-protocols`
	+ Gives info about the SMB versions
+ `smb-security-mode`
	+ Gives info about message signing, guest accounts
+ `smb-os-discovery`
	+ Gives info about OS and server version
+ `smb-enum-sessions`
	+ Gives info about connected users
	+ Can give more info if credentials are passed
+ `smb-enum-shares`
	+ Gives info about accessible shares
	+ Can give more info if credentials are passed
+ `smb-enum-users`
	+ Gives a list of users
	+ Can give more info if credentials are passed
+ `smb-server-stats`
	+ Gives server stats about logins, data transfers
	+ Needs credentials
+ `smb-enum-domains`
	+ Gives a list of domains on the machine
	+ Needs credentials
+ `smb-enum-groups`
	+ Gives a list of groups and their members
	+ Needs credentials
+ `smb-enum-services`
	+ Gives a list of services running
	+ Needs credentials
+ `smb-enum-shares,smb-ls`
	+ Enumerates shares and lists what's inside
	+ Needs credentials

## Useful tools :
+ [[SMBMap]] can perform shares enumeration, sometimes execute commands, upload or download files
+ `auxiliary/scanner/smb/*` on [[Metasploit]]
+ `nmblookup -A IP` can give info about the domain
+ [[enum4linux]] : general enumeration script for linux machines.
	+ `enum4linux -a -u "user" -p "pass" IP` for generic enumeration

## Dictionary attack :
+ With [[Metasploit]] :
	+ `auxiliary/scanner/smb/smb_login`
+ With [[Hydra]] :
	+ `hydra -l user -P 'password_list' IP smb`
	+ can use `-L` for list of users, `-p` for single password

## Pivoting to other services :
Other services can be shared through SMB with he use of names pipes.
+ Enumerating with [[Metasploit]] :
	+ `auxiliary/scanner/smb/pipe_auditor`

## Attacks
+ Using PsExec :
	+ PsExec is a telnet replacement, which uses SMB for authentification. Using it can give us a shell on the target, given valid SMB credentials.
	+ The PsExec utility is a Windows executable, but psexec.py is a script that implements the same protocol
	+ `psexec.py USER@IP cmd.exe`
	+ `exploit/windows/smb/psexec` on [[Metasploit]]
+ EternalBlue :
	+ MS017-010
	+ Targets SMBv1, provides Arbitrary Code Execution with elevated privileges
	+ Checking for the vulnerability
		+ `auxiliary/scanner/smb/smb_ms17_010` to scan a target
		+ `smb-vuln-ms17_010` script on [[Nmap]]
	+ Exploiting it
		+ `exploit/windows/smb/ms17_010_eternalblue` on [[Metasploit]]
		+ Autoblue tool on [GitHub](https://github.com/3ndG4me/AutoBlue-MS17-010)